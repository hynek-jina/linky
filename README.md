# Linky

> ⚠️ Hobby tool without any guarantees. Use at your own risk.

Linky is a simple mobile-first PWA for managing contacts, messaging via Nostr, and sending Lightning payments using Cashu tokens.
It is local-first: your data is stored locally and the app works offline.

## Used protocols

- nostr - communication
- evolu - data storage
- cashu, mints - lightning integration
- npub.cash - lightning address management
- credo - promises - for details see Credo.md

## How it works

- You can either use existing `nsec` or `Create account` - Linky generates a nostr identity `nsec`/`npub` key pair

- `nsec` is used for:
  - derivation of `seed` - 12 words (BIP39)
  - selection of default name and avatar
  - profile management - photo, name, lightning address
  - sending encrypted and private messages - gift-wrapped (NIP17)
  - registering lightning address on npub.cash
  - managing main cashu mint on npub.cash
  - collecting cashu tokens from npub.cash
  - issuing own credo tokens

- `seed` is used for:
  - authentication against evolu servers
  - cashu token requests and token restoration

- Evolu is used for local-first data storage and synchronization between devices.
  - Contacts (npub, name, lightning address, group)
  - Cashu tokens (token, status)
  - Credo tokens (emitted, received)
  - Main mint

## Feature set

- Contacts
  - Scan, add, edit contacts
  - Share your profile (`npub`) including name, photo, and lightning address
- Messages
  - Encrypted private chat via Nostr (NIP-17)
  - Cashu and Credo tokens are rendered as pills in chat
- Wallet
  - Paste and store Cashu tokens
  - Balance shows only Cashu; Credo promises are listed separately
- Payments
  - Pay to contact
    - Lightning if selected or if Cashu/Credo message payment isn’t available
    - Cashu/Credo message payment: consume Credo owed to you first, then Cashu, then (optionally) issue a Credo promise for the remainder
  - Credo promises are capped (100,000 sat) and expire in ~1 month
  - Scan Lightning invoices
  - Top-up via Lightning invoice generated by the main Cashu mint

## Push Notifications

Linky supports push notifications for new Nostr messages using Web Push API and Vercel Cron jobs.

### Architecture

- **Frontend (PWA)**: Registers push subscription and stores it in Vercel KV
- **Vercel Cron**: Runs every minute to check for new DM messages on Nostr relays
- **Service Worker**: Receives and displays push notifications

### Setup

1. **Generate VAPID keys**:
   ```bash
   npx web-push generate-vapid-keys
   ```

2. **Set environment variables in Vercel**:
   ```
   VAPID_PUBLIC_KEY=<your-public-key>
   VAPID_PRIVATE_KEY=<your-private-key>
   KV_REST_API_URL=<vercel-kv-url>
   KV_REST_API_TOKEN=<vercel-kv-token>
   ```

3. **Add VAPID public key to frontend** (`.env`):
   ```
   VITE_VAPID_PUBLIC_KEY=<your-public-key>
   ```

### How it works

- Cron job runs daily (Hobby tier limitation), queries user's relays for new DM events
- When new message found, sends push notification via web-push
- User receives notification even when app is closed
- Clicking notification opens Linky with chat

### Hobby Tier Limitation

**Vercel Hobby tier only allows 1 cron job per day.** The cron is configured to run once daily at midnight UTC.

#### Manual Trigger

You can manually trigger the check by calling the endpoint with a secret:

```bash
curl -X GET "https://your-app.vercel.app/api/check-messages?secret=YOUR_SECRET"
```

Add `CRON_SECRET` to your environment variables.

#### Alternative: External Cron Service

For more frequent checks, use a free external cron service like [cron-job.org](https://cron-job.org):

1. Sign up at cron-job.org (free)
2. Create a job that calls your endpoint every minute:
   ```
   GET https://your-app.vercel.app/api/check-messages?cron=1
   ```
3. Set the cron schedule to every minute

This bypasses Vercel's cron limitations while staying on the free tier.

## Running the project

Requirements: Node.js + npm.

```bash
nvm i
npm install
npm run dev
```

Production build:

```bash
npm run build
```

Preview production build:

```bash
npm run preview
```
